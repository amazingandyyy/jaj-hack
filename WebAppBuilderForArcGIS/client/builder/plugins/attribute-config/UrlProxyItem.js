// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/Evented","./AppProxyUtil"],function(c,e,d,g,f){c=c([g],{appProxyManager:null,title:"",sourceUrl:"",proxyUrl:"",proxyId:"",premium:!0,consumeCredits:!1,constructor:function(b){d.mixin(this,b);this.premium=f.isPremium(this.sourceUrl);this.consumeCredits=f.consumesCredits(this.sourceUrl)},createProxy:function(){this._startProcess();if(this.premium||this.consumeCredits)if(this.appProxyManager){var b=!1;this.appProxyManager.proxies&&
0<this.appProxyManager.proxies.length&&(b=e.some(this.appProxyManager.proxies,function(a){return a.sourceUrl===this.sourceUrl&&a.proxyId&&a.proxyUrl}));if(b)this._checkCreateProxiesCallback(this.appProxyManager.proxies);else try{this.appProxyManager.createProxies([{sourceUrl:this.sourceUrl}]).then(d.hitch(this,function(a){this._checkCreateProxiesCallback(a)}),d.hitch(this,function(){this._checkCreateProxiesCallback([])}))}catch(a){this._checkCreateProxiesCallback([])}}else this._checkCreateProxiesCallback([]);
else this.emit("processError",this.nls.notValidPremiumUrl+" "+this.sourceUrl),this._stopProcess()},_checkCreateProxiesCallback:function(b){e.some(b,d.hitch(this,function(a){if(a.sourceUrl===this.sourceUrl)return this.proxyUrl=a.proxyUrl,this.proxyId=a.proxyId,!0}))?this.emit("proxyCreated",{sourceUrl:this.sourceUrl,proxyUrl:this.proxyUrl,proxyId:this.proxyId,title:this.title,premium:this.premium,consumeCredits:this.consumeCredits,useProxy:!0}):(this.proxyUrl=this.proxyId="",this.useProxy=!1,this.emit("processError",
this.nls.createProxyFailed+" "+this.sourceUrl));this._stopProcess()},deleteProxy:function(){this._startProcess();if(this.appProxyManager&&this.proxyId)try{this.appProxyManager.deleteProxies([{proxyId:this.proxyId}]).then(d.hitch(this,function(b){var a=e.some(b,d.hitch(this,function(a){return a.sourceUrl===this.sourceUrl&&!1===a.proxied}));a||(a=e.every(b,d.hitch(this,function(a){return a.sourceUrl!==this.sourceUrl})));a?(this.proxyId=this.proxyUrl="",this.emit("proxyDeleted",this.sourceUrl)):this.emit("processError",
this.nls.deleteProxyFailed+" "+this.sourceUrl);this._stopProcess()}),d.hitch(this,function(){this.emit("processError",this.nls.deleteProxyFailed+" "+this.sourceUrl);this._stopProcess()}))}catch(b){this.emit("processError",this.nls.deleteProxyFailed+" "+this.sourceUrl),this._stopProcess()}else this.emit("processError",this.nls.deleteProxyFailed+" "+this.sourceUrl),this._stopProcess()},_startProcess:function(){this.emit("processStart")},_stopProcess:function(){this.emit("processEnd")}});c.PROXY_CREATED=
"proxyCreated";c.PROCESS_START="processStart";c.PROXY_DELETED="proxyDeleted";c.PROCESS_END="processEnd";c.PROCESS_ERROR="processError";return c});